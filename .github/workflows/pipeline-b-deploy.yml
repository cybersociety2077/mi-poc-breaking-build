# ================================================================
# PIPELINE B â€” Application Deploy (con Security Gate)
# ================================================================
# Simula un pipeline de despliegue que consulta los resultados
# de seguridad de Pipeline A y decide si romper el build.
#
# Flujo:
#   build â†’ test â†’ security-gate â†’ deploy-staging â†’ deploy-production
#
# Si security-gate falla â†’ el pipeline se rompe y NO despliega.
# ================================================================

name: "Pipeline B â€” Deploy (Breaking Build)"

# â”€â”€ CuÃ¡ndo se ejecuta â”€â”€
on:
  # Manual: para probar el breaking build
  workflow_dispatch:
    inputs:
      security_policy:
        description: "PolÃ­tica de seguridad a aplicar"
        required: true
        default: "moderate"
        type: choice
        options:
          - strict
          - moderate
          - permissive

  # En cada push a main (simula deploy real)
  # NOTA: Ignoramos cambios en results/ para no crear un loop
  # (Pipeline A commitea en results/ â†’ trigger Pipeline B â†’ loop)
  push:
    branches:
      - main
    paths-ignore:
      - "results/**"
      - "**.md"

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build (simulado)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: "ğŸ”¨ Build"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ”¨ Simular build de la aplicaciÃ³n"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Simulando build de la aplicaciÃ³n..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Dependencias instaladas"
          echo "  âœ… CÃ³digo compilado"
          echo "  âœ… Imagen Docker construida"
          echo "  âœ… Build exitoso"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Unit Tests (simulado)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: "ğŸ§ª Tests"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: "ğŸ§ª Simular tests unitarios"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando tests unitarios..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… 42 tests passed"
          echo "  âœ… 0 tests failed"
          echo "  âœ… Coverage: 87%"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: SECURITY GATE ğŸ›¡ï¸ (el breaking build)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Este es EL job que rompe el pipeline si hay
  # vulnerabilidades que violen la polÃ­tica.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-gate:
    name: "ğŸ›¡ï¸ Security Gate"
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: "ğŸ“¥ Checkout (con resultados de Pipeline A)"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # â”€â”€ Verificar que existan resultados â”€â”€
      - name: "ğŸ“‚ Verificar resultados de Pipeline A"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Buscando resultados de Pipeline A..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ -f results/latest.json ]; then
            echo "âœ… Encontrado: results/latest.json"
            echo ""
            echo "Resumen rÃ¡pido:"
            python -c "
          import json
          with open('results/latest.json') as f:
              data = json.load(f)
          s = data.get('summary', {})
          print(f'  App:      {data.get(\"app\", \"?\")}'  )
          print(f'  Timestamp: {data.get(\"timestamp\", \"?\")}'  )
          print(f'  Findings:  {s.get(\"total\", 0)} total')
          print(f'  Critical:  {s.get(\"critical\", 0)}')
          print(f'  High:      {s.get(\"high\", 0)}')
          print(f'  Medium:    {s.get(\"medium\", 0)}')
          print(f'  Low:       {s.get(\"low\", 0)}')
          "
          else
            echo "âš ï¸  No se encontrÃ³ results/latest.json"
            echo "   Â¿Ya ejecutaste Pipeline A?"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸš¨ AQUÃ SE DECIDE: PASS o BREAK
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸš¨ Ejecutar Security Gate"
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸ›¡ï¸  SECURITY GATE â€” EVALUANDO...   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Determinar la polÃ­tica a usar
          POLICY="${{ github.event.inputs.security_policy || 'moderate' }}"

          # Ejecutar el security gate
          # Si retorna exit code 1 â†’ el step falla â†’ el pipeline se rompe
          python scripts/security_gate.py \
            --input results/latest.json \
            --policy "$POLICY"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Deploy a Staging (solo si pasa el gate)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: "ğŸš€ Deploy Staging"
    runs-on: ubuntu-latest
    needs: security-gate  # â† Depende del security gate

    steps:
      - name: "ğŸš€ Simular deploy a staging"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Desplegando a Staging..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Security Gate pasÃ³ correctamente"
          echo "  âœ… Imagen desplegada en staging"
          echo "  âœ… Health check: OK"
          echo "  ğŸŒ URL: https://staging.mi-app.com"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Deploy a ProducciÃ³n (manual)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: "ğŸ­ Deploy Production"
    runs-on: ubuntu-latest
    needs: deploy-staging
    # En producciÃ³n real, esto serÃ­a un environment con approvals
    # Para la POC lo dejamos como step final
    environment:
      name: production

    steps:
      - name: "ğŸ­ Simular deploy a producciÃ³n"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Desplegando a ProducciÃ³n..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Security Gate pasÃ³"
          echo "  âœ… Staging verificado"
          echo "  âœ… Imagen desplegada en producciÃ³n"
          echo "  ğŸŒ URL: https://mi-app.com"
          echo ""
          echo "  ğŸ‰ Deploy completado exitosamente!"
