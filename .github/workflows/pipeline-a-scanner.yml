# ================================================================
# PIPELINE A â€” Security Scanner (v3 â€” fix: ZAP action + verified output)
# ================================================================
# Este workflow levanta OWASP Juice Shop, ejecuta 3 scanners de
# seguridad y commitea los resultados en results/latest.json
# ================================================================

name: "Pipeline A â€” Security Scanner"

on:
  workflow_dispatch:
    inputs:
      target_app:
        description: "Nombre de la app a escanear"
        required: true
        default: "juice-shop"

permissions:
  contents: write

jobs:
  security-scan:
    name: "ğŸ” Run Security Scans"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout repo"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "ğŸ“¦ Install Python dependencies"
        run: pip install requests

      - name: "ğŸ“ Crear directorio results"
        run: mkdir -p results

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LEVANTAR JUICE SHOP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ§ƒ Levantar Juice Shop"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Descargando y levantando Juice Shop"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          docker pull bkimminich/juice-shop:latest
          docker run -d \
            --name juice-shop \
            -p 3000:3000 \
            bkimminich/juice-shop:latest
          echo "âœ… Contenedor iniciado"

      - name: "â³ Esperar a Juice Shop"
        run: |
          echo "Esperando a que Juice Shop estÃ© listo..."
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200"; then
              echo "âœ… Juice Shop estÃ¡ listo! (intento $i)"
              exit 0
            fi
            echo "  Intento $i/60 â€” esperando 5s..."
            sleep 5
          done
          echo "âŒ Juice Shop no respondiÃ³ a tiempo"
          docker logs juice-shop
          exit 1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 1: Security Headers
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”’ Scan 1: Security Headers"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando check de Security Headers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python scripts/check_headers.py \
            --url http://localhost:3000 \
            --output results/headers.json

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 2: OWASP ZAP Baseline
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Usamos la GitHub Action oficial de ZAP que es mÃ¡s
      # confiable que docker run manual para generar reportes.
      - name: "âš¡ Scan 2: OWASP ZAP Baseline"
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://localhost:3000"
          rules_file_name: ""
          cmd_options: "-I -l WARN"
          allow_issue_writing: false
        continue-on-error: true

      # El action de ZAP genera automÃ¡ticamente estos archivos
      # en el workspace. Necesitamos mover/copiar el JSON a results/
      - name: "ğŸ“‹ Procesar resultados de ZAP"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Buscando resultados de ZAP..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # La action de ZAP genera report_json.json en el workspace
          # Buscar todos los archivos JSON que ZAP pudo generar
          echo "Archivos en workspace:"
          find ${{ github.workspace }} -name "*.json" -newer results/headers.json 2>/dev/null || true
          echo ""

          # ZAP action genera report_json.json o similar
          if [ -f "${{ github.workspace }}/report_json.json" ]; then
            cp "${{ github.workspace }}/report_json.json" results/zap.json
            echo "âœ… ZAP report encontrado: report_json.json"
          elif [ -f "${{ github.workspace }}/zap-report.json" ]; then
            cp "${{ github.workspace }}/zap-report.json" results/zap.json
            echo "âœ… ZAP report encontrado: zap-report.json"
          else
            # Buscar cualquier JSON generado por ZAP
            ZAP_FILE=$(find ${{ github.workspace }} -maxdepth 1 -name "*.json" \
              ! -path "*/results/*" ! -name "package*.json" \
              -newer results/headers.json -print -quit 2>/dev/null)

            if [ -n "$ZAP_FILE" ]; then
              cp "$ZAP_FILE" results/zap.json
              echo "âœ… ZAP report encontrado: $ZAP_FILE"
            else
              echo "âš ï¸  No se encontrÃ³ reporte JSON de ZAP"
              echo "   Generando reporte vacÃ­o..."
              echo '{"site":[],"@version":"0","@generated":"N/A"}' > results/zap.json
            fi
          fi

          echo ""
          echo "Contenido de results/zap.json (primeros 500 chars):"
          head -c 500 results/zap.json
          echo ""
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 3: TLS/SSL Check
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ” Scan 3: TLS/SSL Check"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando TLS/SSL Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo '{
            "scanner": "testssl",
            "note": "Target is HTTP-only (localhost). TLS scan skipped.",
            "scanResult": [{
              "targetHost": "localhost:3000",
              "protocols": [],
              "vulnerabilities": [{
                "id": "NO_TLS",
                "severity": "HIGH",
                "finding": "Target does not support HTTPS/TLS. All traffic is unencrypted."
              }]
            }]
          }' > results/tls.json
          echo "âš ï¸  Juice Shop corre en HTTP (sin TLS)"
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERIFICAR: quÃ© archivos tenemos
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ” Verificar archivos de resultados"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Archivos en results/"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ls -la results/
          echo ""
          for f in results/headers.json results/zap.json results/tls.json; do
            if [ -f "$f" ]; then
              SIZE=$(wc -c < "$f")
              echo "âœ… $f ($SIZE bytes)"
            else
              echo "âŒ $f â€” NO ENCONTRADO"
            fi
          done

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NORMALIZAR
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”„ Normalizar resultados"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Unificando resultados de scanners"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          APP_NAME="${{ github.event.inputs.target_app || 'juice-shop' }}"
          python scripts/normalize_results.py \
            --app "$APP_NAME" \
            --headers results/headers.json \
            --zap results/zap.json \
            --tls results/tls.json \
            --output results/latest.json

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # MOSTRAR RESULTADOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“‹ Mostrar resultados"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Contenido de results/latest.json"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat results/latest.json | python -m json.tool

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CLEANUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ§¹ Detener Juice Shop"
        if: always()
        run: |
          docker stop juice-shop || true
          docker rm juice-shop || true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # COMMIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ’¾ Commit resultados al repo"
        run: |
          git config user.name "Security Scanner Bot"
          git config user.email "security-bot@github-actions"
          git add results/
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No hay cambios nuevos en los resultados"
          else
            git commit -m "ğŸ” Security scan results â€” $(date -u +%Y-%m-%dT%H:%M:%SZ)

            Pipeline: ${{ github.run_id }}
            App: ${{ github.event.inputs.target_app || 'juice-shop' }}
            Scans: headers, zap, tls"
            git push
            echo "âœ… Resultados commiteados exitosamente"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPLOAD ARTIFACTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“¤ Upload scan artifacts"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: results/
          retention-days: 30
