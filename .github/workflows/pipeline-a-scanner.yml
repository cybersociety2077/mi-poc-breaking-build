# ================================================================
# PIPELINE A â€” Security Scanner (v2 â€” fix: manual Docker start)
# ================================================================
# Este workflow levanta OWASP Juice Shop, ejecuta 3 scanners de
# seguridad y commitea los resultados en results/latest.json
#
# EjecuciÃ³n:
#   - Manual: desde la pestaÃ±a Actions > "Pipeline A" > Run workflow
#   - AutomÃ¡tico: cada dÃ­a a las 2am UTC (puedes cambiarlo)
#   - Por API: desde Pipeline B u otro workflow
#
# NOTA: Juice Shop se levanta manualmente con docker run en vez de
# usar "services:" porque la imagen es pesada y el health check
# de services tiene un timeout limitado.
# ================================================================

name: "Pipeline A â€” Security Scanner"

# â”€â”€ CuÃ¡ndo se ejecuta â”€â”€
on:
  # Manual desde GitHub UI
  workflow_dispatch:
    inputs:
      target_app:
        description: "Nombre de la app a escanear"
        required: true
        default: "juice-shop"

  # AutomÃ¡tico cada dÃ­a a las 2am UTC
  schedule:
    - cron: "0 2 * * *"

# â”€â”€ Permisos â”€â”€
# Necesita escribir en el repo para commitear resultados
permissions:
  contents: write

# â”€â”€ Jobs â”€â”€
jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Levantar Juice Shop y escanear
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: "ğŸ” Run Security Scans"
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout del repo â”€â”€
      - name: "ğŸ“¥ Checkout repo"
        uses: actions/checkout@v4

      # â”€â”€ Setup Python â”€â”€
      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "ğŸ“¦ Install Python dependencies"
        run: pip install requests

      # â”€â”€ Crear directorio de resultados â”€â”€
      - name: "ğŸ“ Crear directorio results"
        run: mkdir -p results

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LEVANTAR JUICE SHOP (manual con docker)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ§ƒ Levantar Juice Shop"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Descargando y levantando Juice Shop"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Descargar la imagen primero (puede tardar ~1-2 min)
          docker pull bkimminich/juice-shop:latest

          # Levantar en background
          docker run -d \
            --name juice-shop \
            -p 3000:3000 \
            bkimminich/juice-shop:latest

          echo "âœ… Contenedor iniciado"

      # â”€â”€ Esperar a que Juice Shop estÃ© listo â”€â”€
      - name: "â³ Esperar a Juice Shop"
        run: |
          echo "Esperando a que Juice Shop estÃ© listo..."
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200"; then
              echo "âœ… Juice Shop estÃ¡ listo! (intento $i)"
              exit 0
            fi
            echo "  Intento $i/60 â€” esperando 5s..."
            sleep 5
          done
          echo "âŒ Juice Shop no respondiÃ³ a tiempo"
          echo "Logs del contenedor:"
          docker logs juice-shop
          exit 1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 1: Security Headers
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”’ Scan 1: Security Headers"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando check de Security Headers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python scripts/check_headers.py \
            --url http://localhost:3000 \
            --output results/headers.json

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 2: OWASP ZAP Baseline
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ZAP Baseline es un scan rÃ¡pido (~2-5 min) que busca
      # vulnerabilidades comunes sin hacer fuzzing agresivo.
      # Perfecto para CI/CD.
      - name: "âš¡ Scan 2: OWASP ZAP Baseline"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando OWASP ZAP Baseline Scan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Correr ZAP en modo baseline (rÃ¡pido, no intrusivo)
          # -t: target URL
          # -J: output en JSON
          # -r: output en HTML (para reporte visual)
          # -l WARN: nivel mÃ­nimo de alerta
          # -I: no fallar el step por findings (nosotros controlamos eso en security_gate)
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}/results:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t http://localhost:3000 \
              -J zap.json \
              -r zap-report.html \
              -l WARN \
              -I
        # ZAP puede retornar exit code != 0 si encuentra findings
        # Pero nosotros NO queremos que Pipeline A falle por eso
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SCAN 3: TLS/SSL con testssl.sh
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NOTA: Juice Shop en localhost usa HTTP, no HTTPS.
      # En un caso real, escanearÃ­as el dominio con HTTPS.
      # Para la POC, generamos un reporte que muestra
      # que el target no tiene TLS.
      - name: "ğŸ” Scan 3: TLS/SSL Check"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Ejecutando TLS/SSL Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Juice Shop en localhost no tiene HTTPS,
          # asÃ­ que testssl.sh no puede escanear TLS.
          # En producciÃ³n, harÃ­as:
          #   docker run --rm --network host \
          #     drwetter/testssl.sh \
          #     --jsonfile /output/tls.json \
          #     https://tu-app.com

          # Para la POC, generamos un resultado que refleja esto:
          echo '{
            "scanner": "testssl",
            "note": "Target is HTTP-only (localhost). TLS scan skipped.",
            "scanResult": [{
              "targetHost": "localhost:3000",
              "protocols": [],
              "vulnerabilities": [{
                "id": "NO_TLS",
                "severity": "HIGH",
                "finding": "Target does not support HTTPS/TLS. All traffic is unencrypted."
              }]
            }]
          }' > results/tls.json

          echo "âš ï¸  Juice Shop corre en HTTP (sin TLS)"
          echo "   En producciÃ³n, testssl.sh escanearÃ­a el dominio HTTPS real"
          echo "   Se reporta como finding HIGH: No TLS"
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NORMALIZAR: Unificar todos los resultados
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”„ Normalizar resultados"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Unificando resultados de 3 scanners"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Determinar nombre de la app
          APP_NAME="${{ github.event.inputs.target_app || 'juice-shop' }}"

          python scripts/normalize_results.py \
            --app "$APP_NAME" \
            --headers results/headers.json \
            --zap results/zap.json \
            --tls results/tls.json \
            --output results/latest.json

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERIFICAR: Mostrar el resultado
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“‹ Mostrar resultados"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Contenido de results/latest.json"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat results/latest.json | python -m json.tool

          echo ""
          echo "Archivos generados:"
          ls -la results/

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CLEANUP: Detener Juice Shop
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ§¹ Detener Juice Shop"
        if: always()
        run: |
          docker stop juice-shop || true
          docker rm juice-shop || true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # COMMIT: Guardar resultados en el repo
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ’¾ Commit resultados al repo"
        run: |
          git config user.name "Security Scanner Bot"
          git config user.email "security-bot@github-actions"

          # Agregar solo los archivos de resultados
          git add results/

          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No hay cambios nuevos en los resultados"
          else
            git commit -m "ğŸ” Security scan results â€” $(date -u +%Y-%m-%dT%H:%M:%SZ)

            Pipeline: ${{ github.run_id }}
            App: ${{ github.event.inputs.target_app || 'juice-shop' }}
            Scans: headers, zap, tls"

            git push
            echo "âœ… Resultados commiteados exitosamente"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPLOAD: Artefactos (backup + reportes HTML)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“¤ Upload scan artifacts"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            results/
          retention-days: 30
